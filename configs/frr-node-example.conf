# ============================================
# FRR (Free Range Routing) 配置示例
# 节点: Node-1
# IP: 192.168.1.10
# AS: 4200000001
# 角色: Kubernetes 计算节点 + BGP Speaker
# ============================================

# 基础配置
frr version 8.4
frr defaults traditional
hostname node-1
log syslog informational
log facility local0
service integrated-vtysh-config
!

# ============================================
# Zebra 配置 (内核路由管理)
# ============================================
# Zebra 作用:
# 1. 从内核读取路由 (直连接口、静态路由)
# 2. 将 BGP 学到的路由写入内核
# 3. 监听接口状态变化

# 启用 IPv4 转发
ip forwarding
!

# 从内核导入直连路由
# 用于将容器路由 (cali* 接口) 注入 BGP
ip protocol connected route-map REDISTRIBUTE_CONNECTED
!

# 路由映射: 只重分发容器网段
route-map REDISTRIBUTE_CONNECTED permit 10
  match interface cali+           # 匹配所有 cali 开头的接口
  match ip address prefix-list CONTAINER_IPS
!
route-map REDISTRIBUTE_CONNECTED deny 20
!

# 定义容器 IP 范围
ip prefix-list CONTAINER_IPS seq 10 permit 10.244.0.0/16 le 32
!

# ============================================
# BGP 配置
# ============================================
router bgp 4200000001
  # Router ID (使用节点管理 IP)
  bgp router-id 192.168.1.10

  # 禁用默认的 IPv4 unicast (显式激活)
  no bgp default ipv4-unicast

  # 日志配置
  bgp log-neighbor-changes

  # BGP 最佳路径选择
  bgp bestpath as-path multipath-relax   # 允许不同 AS Path 的 ECMP
  bgp bestpath compare-routerid          # 比较 Router ID

  # BGP 定时器 (更快的故障检测)
  timers bgp 30 90                       # keepalive 30s, hold time 90s

  # 优雅重启 (避免路由震荡)
  bgp graceful-restart                   # 启用优雅重启
  bgp graceful-restart stalepath-time 360
  bgp graceful-restart restart-time 120

  # ============================================
  # 邻居组配置: Leaf 交换机
  # ============================================
  neighbor LEAF peer-group
  neighbor LEAF remote-as external       # eBGP, AS 号自动检测
  neighbor LEAF ebgp-multihop 1         # 直连, TTL=1
  neighbor LEAF capability extended-nexthop  # 支持 IPv6 下一跳
  neighbor LEAF timers connect 10        # 连接重试 10s
  neighbor LEAF advertisement-interval 0 # 无延迟发送更新

  # Leaf-1 (主路径)
  neighbor 192.168.1.1 peer-group LEAF
  neighbor 192.168.1.1 remote-as 65001
  neighbor 192.168.1.1 description "Leaf-1 Primary"

  # Leaf-2 (备用路径)
  neighbor 192.168.1.2 peer-group LEAF
  neighbor 192.168.1.2 remote-as 65001
  neighbor 192.168.1.2 description "Leaf-2 Backup"

  # ============================================
  # IPv4 地址族配置
  # ============================================
  address-family ipv4 unicast
    # 激活邻居
    neighbor LEAF activate

    # 从 Zebra 重分发连接路由 (容器路由)
    redistribute connected route-map REDISTRIBUTE_CONNECTED

    # 导入路由策略 (从 Leaf 接收)
    neighbor LEAF route-map IMPORT_FROM_LEAF in
    neighbor LEAF soft-reconfiguration inbound  # 保存原始路由

    # 导出路由策略 (向 Leaf 发送)
    neighbor LEAF route-map EXPORT_TO_LEAF out

    # ECMP 配置
    maximum-paths 32                     # 最多 32 条等价路径
    maximum-paths ibgp 32                # iBGP ECMP (未来扩展)

    # 网络声明 (可选，如果不用 redistribute connected)
    # network 10.244.1.0/24
  exit-address-family
  !
!

# ============================================
# 路由策略: 从 Leaf 导入
# ============================================
# 接收所有容器路由
route-map IMPORT_FROM_LEAF permit 10
  match ip address prefix-list CONTAINER_IPS
  # 设置本地优先级 (可选)
  set local-preference 100
!
# 拒绝默认路由 (安全)
route-map IMPORT_FROM_LEAF deny 20
  match ip address prefix-list DEFAULT_ROUTE
!
route-map IMPORT_FROM_LEAF permit 30
!

ip prefix-list DEFAULT_ROUTE seq 10 permit 0.0.0.0/0
!

# ============================================
# 路由策略: 向 Leaf 导出
# ============================================
# 仅发布本节点的 /32 容器路由
route-map EXPORT_TO_LEAF permit 10
  match ip address prefix-list CONTAINER_IPS
  match ip address prefix-len 32        # 仅 /32 主机路由
  # 设置 BGP Community (可选，用于标记)
  set community 65001:100 additive
  # 设置 MED (可选，影响路径选择)
  # set metric 10
!
# 拒绝其他所有路由
route-map EXPORT_TO_LEAF deny 20
!

# ============================================
# BFD 配置 (快速故障检测)
# ============================================
# BFD (Bidirectional Forwarding Detection)
# 功能: 在 300ms 内检测链路故障 (3 * 100ms)

bfd
  # 定义 BFD profile
  profile leaf-bfd
    detect-multiplier 3              # 检测倍数: 丢失 3 个包=故障
    receive-interval 100             # 接收间隔: 100ms
    transmit-interval 100            # 发送间隔: 100ms
    echo-mode                        # 启用 echo 模式 (可选)
    minimum-ttl 254                  # 防止攻击
  !
!

# 为 BGP 邻居启用 BFD
router bgp 4200000001
  neighbor LEAF bfd                  # 对所有 Leaf 邻居启用 BFD
  neighbor LEAF bfd profile leaf-bfd # 使用自定义 profile
!

# ============================================
# Static 路由 (可选)
# ============================================
# 如果需要静态路由兜底
# ip route 0.0.0.0/0 192.168.1.254
!

# ============================================
# Access List (可选，更精细的过滤)
# ============================================
# ip access-list standard CONTAINER_ACL
#   permit 10.244.0.0 0.0.255.255
# !

# ============================================
# RPKI (可选，路由源验证)
# ============================================
# 仅在与公网 BGP 对接时使用
# rpki
#   rpki server 192.0.2.1 port 323
# !

# ============================================
# VRF 支持 (可选，多租户)
# ============================================
# vrf tenant1
#   ip route 10.1.0.0/16 Null0
# !
# router bgp 4200000001 vrf tenant1
#   address-family ipv4 unicast
#     redistribute connected
#   exit-address-family
# !

# ============================================
# 监控和管理
# ============================================

# 启用 SNMP (可选)
# agentx
!

# 配置访问控制
line vty
  exec-timeout 0 0
  no login
!

# ============================================
# 验证和调试命令 (在 vtysh 中执行)
# ============================================

# === 查看 BGP 状态 ===
# show ip bgp summary               # BGP 邻居摘要
# show ip bgp neighbors             # 邻居详情
# show ip bgp neighbors 192.168.1.1 advertised-routes  # 发布的路由
# show ip bgp neighbors 192.168.1.1 routes             # 接收的路由

# === 查看路由 ===
# show ip bgp                       # BGP 路由表
# show ip route                     # 内核路由表
# show ip route bgp                 # 仅 BGP 路由

# === 查看 BFD ===
# show bfd peers                    # BFD 会话状态
# show bfd peer 192.168.1.1         # 特定邻居的 BFD

# === 调试 ===
# debug bgp updates                 # 调试 BGP 更新
# debug bgp neighbor-events         # 调试邻居事件
# debug bfd network                 # 调试 BFD

# === 清空会话 ===
# clear ip bgp *                    # 清空所有 BGP 会话
# clear ip bgp 192.168.1.1          # 清空特定邻居

# === 配置保存 ===
# write memory                      # 保存配置
# write file /etc/frr/frr.conf      # 保存到指定文件

# ============================================
# 性能调优
# ============================================

# 内核参数优化 (在 /etc/sysctl.conf 中配置)
# net.ipv4.fib_multipath_hash_policy=1        # L3+L4 哈希 (ECMP)
# net.ipv4.conf.all.rp_filter=0               # 禁用反向路径过滤
# net.ipv4.conf.default.rp_filter=0
# net.ipv4.ip_forward=1                       # 启用转发
# net.ipv4.tcp_mtu_probing=1                  # MTU 探测
# net.core.netdev_max_backlog=5000            # 网卡队列
# net.ipv4.neigh.default.gc_thresh1=1024
# net.ipv4.neigh.default.gc_thresh2=4096
# net.ipv4.neigh.default.gc_thresh3=8192

# ============================================
# Systemd 服务配置
# ============================================
# /etc/systemd/system/frr.service.d/override.conf
# [Service]
# LimitNOFILE=65535
# LimitNPROC=65535

# ============================================
# 日志配置
# ============================================
# /etc/frr/daemons
# bgpd=yes
# zebra=yes
# bfdd=yes

# /etc/rsyslog.d/frr.conf
# local0.*  /var/log/frr/frr.log

end
