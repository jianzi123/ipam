# BIRD 2.0+ 配置示例
# 节点: Node-1
# IP: 192.168.1.10
# AS: 4200000001
# 连接到: Leaf-1 (192.168.1.1, AS 65001)

# ============================================
# 基础配置
# ============================================

# Router ID (使用节点管理 IP)
router id 192.168.1.10;

# 日志配置
log syslog all;
log "/var/log/bird/bird.log" { debug, trace, info, remote, warning, error, auth, fatal, bug };
debug protocols { states, routes, filters, interfaces };

# ============================================
# 协议配置
# ============================================

# Device protocol - 监听接口变化
protocol device {
  scan time 10;        # 每 10 秒扫描接口变化
}

# Direct protocol - 从直连接口导入路由
# 用于自动检测容器路由 (cali* 接口)
protocol direct {
  ipv4;
  interface "cali*", "tunl*";  # Calico veth pair 和 IPIP tunnel
}

# Kernel protocol - 与内核路由表交互
protocol kernel {
  ipv4 {
    export all;        # 将 BGP 学到的路由导出到内核
    import none;       # 不从内核导入路由（避免循环）
  };
  learn;               # 学习内核路由（用于检测）
  merge paths on;      # 启用 ECMP (Equal-Cost Multi-Path)
  scan time 10;
}

# Static protocol - 静态路由（可选）
protocol static {
  ipv4;
  # 示例：黑洞路由，防止环路
  # route 10.244.0.0/16 blackhole;
}

# ============================================
# BGP 配置
# ============================================

# BGP 模板 - 定义通用配置
template bgp bgp_template {
  local as 4200000001;           # 本节点 AS 号

  # 连接参数
  connect retry time 5;
  connect delay time 5;
  error wait time 5,30;

  # 保活参数
  hold time 90;                  # Hold timer (3 * keepalive)
  keepalive time 30;             # Keepalive 间隔

  # 启用 BFD (Bidirectional Forwarding Detection) - 快速故障检测
  # BFD 可以在 300ms 内检测到链路故障
  bfd on;

  # 路由限制 - 防止路由表爆炸
  receive limit 10000 action restart;  # 最多接收 10000 条路由

  # IPv4 地址族
  ipv4 {
    import all;                  # 接收所有路由
    export where proto = "direct"; # 仅导出直连路由（容器路由）
    next hop self;               # 将下一跳设置为本机
    add paths tx;                # 发送多路径（用于 ECMP）
  };

  # 可选: IPv6 支持
  # ipv6 {
  #   import all;
  #   export where proto = "direct";
  #   next hop self;
  # };
}

# ============================================
# BGP Peering - 连接到 Leaf 交换机
# ============================================

# Peer 1: Leaf-1 (主路径)
protocol bgp leaf1 from bgp_template {
  neighbor 192.168.1.1 as 65001;
  description "BGP peering to Leaf-1 (primary)";

  # 源地址（本机 IP）
  source address 192.168.1.10;

  # 路由策略
  ipv4 {
    import filter {
      # 接收所有容器路由
      if net ~ 10.244.0.0/16 then accept;
      # 拒绝其他路由
      reject;
    };

    export filter {
      # 仅发布本节点的容器 /32 路由
      if proto = "direct" && net ~ 10.244.0.0/16 && net.len = 32 then {
        # 可选：设置 BGP Community 标记
        # bgp_community.add((65001, 100));  # (AS, value)
        accept;
      }
      reject;
    };
  };
}

# Peer 2: Leaf-2 (备用路径，用于冗余)
# 如果节点有双上联到两个 Leaf，可以启用此配置
protocol bgp leaf2 from bgp_template {
  neighbor 192.168.1.2 as 65001;
  description "BGP peering to Leaf-2 (backup)";
  source address 192.168.1.10;

  ipv4 {
    import filter {
      if net ~ 10.244.0.0/16 then accept;
      reject;
    };
    export filter {
      if proto = "direct" && net ~ 10.244.0.0/16 && net.len = 32 then accept;
      reject;
    };
  };
}

# ============================================
# 过滤器定义 (可复用)
# ============================================

# 容器路由过滤器 - 仅允许 10.244.0.0/16 范围的 /32 路由
filter container_routes {
  if net ~ 10.244.0.0/16 && net.len = 32 then {
    accept;
  }
  reject;
}

# 默认路由过滤器 - 拒绝默认路由（安全措施）
filter no_default {
  if net = 0.0.0.0/0 then {
    print "Rejecting default route from ", proto;
    reject;
  }
  accept;
}

# ============================================
# BFD 配置 (可选)
# ============================================

# BFD protocol - 快速链路故障检测
protocol bfd {
  interface "eth*" {
    min rx interval 100 ms;    # 最小接收间隔
    min tx interval 100 ms;    # 最小发送间隔
    idle tx interval 300 ms;   # 空闲时发送间隔
    multiplier 3;              # 检测倍数 (3 * 100ms = 300ms 故障检测)
  };
}

# ============================================
# 调试和监控
# ============================================

# 查看 BGP 状态: birdc show protocols
# 查看路由表: birdc show route
# 查看特定协议路由: birdc show route protocol leaf1
# 查看 BGP 详情: birdc show protocols all leaf1
# 查看 BFD 会话: birdc show bfd sessions

# 示例输出:
# BIRD 2.0.8 ready.
# Name       Proto      Table      State  Since         Info
# leaf1      BGP        ---        up     12:34:56.789  Established
#   BGP state:          Established
#     Neighbor address: 192.168.1.1
#     Neighbor AS:      65001
#     Local AS:         4200000001
#     Import accepted:  5432 routes
#     Export accepted:  127 routes
